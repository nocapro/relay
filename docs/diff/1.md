To achieve the high-fidelity "technical report" aesthetic you're looking for, we need to overhaul the **Transaction Card** to handle complex, multi-file narratives.

In this first part, we will:
1.  Implement the **Sticky Header** logic so the controls (Apply/Status) follow the user as they read through long reports.
2.  Inject **Markdown** rendering for the architectural reasoning.
3.  Optimize the layout for **multi-file streams** (targeting 5+ files per change).

### Part 1/3: The Interactive Document Shell

```typescript // src/features/transactions/components/transaction-card.component.tsx standard-diff
--- src/features/transactions/components/transaction-card.component.tsx
+++ src/features/transactions/components/transaction-card.component.tsx
@@ ... @@
-import { 
-  CheckCircle2, 
-  RefreshCw, 
-  MoreHorizontal, 
-  ChevronDown, 
-  FileCode, 
-  Zap, 
-  Copy, 
-  Terminal,
-  Cpu,
-  Coins,
-  History
-} from 'lucide-react';
+import ReactMarkdown from 'react-markdown';
+import remarkGfm from 'remark-gfm';
+import { 
+  CheckCircle2, 
+  MoreHorizontal, 
+  ChevronDown, 
+  FileCode, 
+  Zap, 
+  Copy, 
+  Terminal,
+  Cpu,
+  Coins,
+  History,
+  ExternalLink
+} from 'lucide-react';
@@ ... @@
   return (
     <motion.div 
       initial={isNew ? { opacity: 0, y: 20 } : false}
       animate={{ opacity: 1, y: 0 }}
       layout
       className={cn(
-        "group border rounded-2xl transition-all duration-500 relative",
+        "group border rounded-2xl transition-all duration-500 relative overflow-hidden",
         expanded 
-          ? "bg-zinc-950 border-zinc-700/50 shadow-2xl z-10 my-8" 
-          : "bg-zinc-900/40 border-zinc-800/60 hover:bg-zinc-900/60 hover:border-zinc-700"
+          ? "bg-zinc-950 border-zinc-700/50 shadow-[0_0_50px_-12px_rgba(0,0,0,0.5)] z-10 my-12" 
+          : "bg-zinc-900/40 border-zinc-800/60 hover:bg-zinc-900/60 hover:border-zinc-700 shadow-sm"
       )}
     >
-      {/* STICKY HEADER: The Control Bar */}
+      {/* STICKY HEADER: Integrated Controls */}
       <div 
         onClick={onToggle}
         className={cn(
-          "z-30 transition-all duration-300 cursor-pointer rounded-t-2xl",
+          "z-40 transition-all duration-300 cursor-pointer select-none",
           expanded 
-            ? "sticky top-[-1px] bg-zinc-950/90 backdrop-blur-xl border-b border-zinc-800/80 px-6 py-4" 
+            ? "sticky top-0 bg-zinc-950/95 backdrop-blur-md border-b border-zinc-800/80 px-6 py-4" 
             : "p-4"
         )}
       >
@@ ... @@
           <div className="flex items-center gap-2">
-            <AnimatePresence>
-              {expanded && tx.status === 'PENDING' && (
-                <motion.button 
-                  initial={{ opacity: 0, scale: 0.9 }}
-                  animate={{ opacity: 1, scale: 1 }}
-                  onClick={handleApprove} 
-                  className="flex items-center gap-2 px-4 py-1.5 bg-emerald-600 hover:bg-emerald-500 text-white text-[11px] font-bold uppercase tracking-wider rounded-lg shadow-lg shadow-emerald-900/20 transition-all active:scale-95"
-                >
-                  <CheckCircle2 className="w-3.5 h-3.5" />
-                  Apply
-                </motion.button>
-              )}
-            </AnimatePresence>
+            {tx.status === 'PENDING' && (
+              <button 
+                onClick={handleApprove} 
+                className={cn(
+                  "flex items-center gap-2 px-4 py-1.5 bg-emerald-600 hover:bg-emerald-500 text-white text-[11px] font-bold uppercase tracking-wider rounded-lg shadow-lg shadow-emerald-900/20 transition-all active:scale-95",
+                  !expanded && "hidden md:flex"
+                )}
+              >
+                <CheckCircle2 className="w-3.5 h-3.5" />
+                Apply
+              </button>
+            )}
             <button className="p-2 text-zinc-600 hover:text-white transition-colors">
@@ ... @@
             {/* Observability Strip */}
-            <div className="flex items-center gap-6 px-8 py-3 bg-zinc-900/40 border-b border-zinc-800/50 overflow-x-auto scrollbar-hide">
+            <div className="flex items-center gap-6 px-8 py-4 bg-zinc-900/30 border-b border-zinc-800/50 overflow-x-auto scrollbar-hide">
                <MetaItem icon={Cpu} label="Engine" value={`${tx.provider} / ${tx.model}`} color="text-indigo-400" />
-               <MetaItem icon={Terminal} label="Resources" value={`${tx.tokens} tokens`} color="text-emerald-400" />
+               <MetaItem icon={Terminal} label="Context" value={`${tx.tokens} tokens`} color="text-emerald-400" />
                <MetaItem icon={Coins} label="Cost" value={tx.cost} color="text-amber-400" />
+               <div className="ml-auto hidden md:flex items-center gap-2 text-[10px] text-zinc-500 font-mono">
+                  <ExternalLink className="w-3 h-3" />
+                  <span>Report v2.4</span>
+               </div>
             </div>
 
-            <div className="p-8 space-y-12 max-w-5xl mx-auto">
+            <div className="p-6 md:p-10 space-y-16 max-w-5xl mx-auto">
               {/* Reasoning Section */}
               <section className="space-y-4">
                 <div className="flex items-center gap-2 text-zinc-500">
                    <Zap className="w-4 h-4 text-amber-500" />
-                   <h4 className="text-[10px] uppercase font-bold tracking-widest">Architectural Intent</h4>
+                   <h4 className="text-[11px] uppercase font-bold tracking-[0.2em]">Architectural Intent</h4>
                 </div>
-                <div className="prose prose-zinc prose-invert prose-sm max-w-none">
+                <div className="prose prose-zinc prose-invert prose-sm max-w-none bg-zinc-900/20 p-6 rounded-2xl border border-zinc-800/40">
+                  <ReactMarkdown remarkPlugins={[remarkGfm]}>
+                    {tx.reasoning}
+                  </ReactMarkdown>
+                </div>
+              </section>
+
+              {/* Detailed Technical Breakdown (New Interleaved Section) */}
+              <section className="space-y-6">
+                 <div className="flex items-center gap-2 text-zinc-500">
+                   <FileCode className="w-4 h-4 text-indigo-500" />
+                   <h4 className="text-[11px] uppercase font-bold tracking-[0.2em]">Implementation ({tx.files.length} Changes)</h4>
+                </div>
+                
+                <div className="grid grid-cols-1 gap-12">
+                  {tx.files.map((file, i) => {
+                    const stats = getDiffStats(file.diff);
+                    return (
+                      <div key={i} className="space-y-3">
+                        {/* File Meta */}
+                        <div className="flex items-center justify-between px-2">
+                           <div className="flex items-center gap-3">
+                              <div className={cn(
+                                "w-1.5 h-1.5 rounded-full",
+                                file.status === 'modified' ? "bg-amber-500 shadow-[0_0_8px_rgba(245,158,11,0.5)]" : 
+                                file.status === 'created' ? "bg-emerald-500 shadow-[0_0_8px_rgba(16,185,129,0.5)]" : "bg-red-500"
+                              )} />
+                              <span className="text-xs font-mono text-zinc-300">{file.path}</span>
+                           </div>
+                           <div className="flex items-center gap-3 text-[10px] font-mono">
+                              <span className="text-emerald-500/80">+{stats.adds}</span>
+                              <span className="text-red-500/80">-{stats.subs}</span>
+                           </div>
+                        </div>
+
+                        {/* File Diff Window */}
+                        <div className="group/file border border-zinc-800/80 rounded-xl overflow-hidden bg-zinc-950 shadow-2xl transition-all hover:border-zinc-700/50">
+                           <div className="flex items-center justify-between px-4 py-2 bg-zinc-900/60 border-b border-zinc-800/80">
+                              <div className="flex gap-1.5">
+                                 <div className="w-2 h-2 rounded-full bg-zinc-800" />
+                                 <div className="w-2 h-2 rounded-full bg-zinc-800" />
+                                 <div className="w-2 h-2 rounded-full bg-zinc-800" />
+                              </div>
+                              <button className="p-1 text-zinc-600 hover:text-white transition-colors opacity-0 group-hover/file:opacity-100">
+                                 <Copy className="w-3.5 h-3.5" />
+                              </button>
+                           </div>
+                           <DiffViewer diff={file.diff} language={file.language} className="max-h-[500px]" />
+                        </div>
+                      </div>
+                    );
+                  })}
+                </div>
+              </section>
+
+              {/* Action Footer */}
+              {tx.status === 'PENDING' && (
+                <div className="flex items-center justify-center pt-8 border-t border-zinc-800/50">
+                   <button 
+                    onClick={handleApprove}
+                    className="px-8 py-3 bg-white text-zinc-950 rounded-xl font-bold text-sm hover:bg-zinc-200 transition-all flex items-center gap-3 shadow-2xl shadow-white/5"
+                   >
+                     <CheckCircle2 className="w-5 h-5" />
+                     Approve Implementation
+                   </button>
+                </div>
+              )}
+            </div>
```

### Part 2/3: The High-Fidelity Data Layer

Next, we update `api.service.ts` to provide the complex, multi-file scenarios.

```typescript // src/services/api.service.ts standard-diff
--- src/services/api.service.ts
+++ src/services/api.service.ts
@@ ... @@
-const MOCK_TRANSACTIONS: Transaction[] = [
-  {
-    id: 'tx-8f92a1',
-    status: 'PENDING',
-    description: 'Refactor authentication middleware to support JWT rotation',
+const MOCK_TRANSACTIONS: Transaction[] = [
+  {
+    id: 'tx-complex-auth',
+    status: 'PENDING',
+    description: 'Security Overhaul: JWT Rotation & Session Management',
     timestamp: 'Just now',
     createdAt: new Date().toISOString(),
     promptId: 'prompt-1',
     author: 'alice',
     files: [
       {
         path: 'src/middleware/auth.ts',
@@ ... @@
-  },
-  {
-    id: 'tx-7b21c4',
-    status: 'FAILED',
-    description: 'Fix race condition in user profile update',
-    timestamp: '2 mins ago',
-    createdAt: new Date(Date.now() - 120000).toISOString(),
-    promptId: 'prompt-2',
-    author: 'bob',
-    files: [
-      {
-        path: 'src/services/userService.ts',
-        status: 'modified',
-        language: 'typescript',
-        diff: `@@ -45,7 +45,8 @@
-   async updateUser(id: string, data: Partial<User>) {
-     const user = await db.users.findUnique({ where: { id } });
-     
--    return db.users.update({
-+    // Fix: Add version check for optimistic locking
-+    return db.users.update({
-       where: { id, version: user.version },
-       data: { ...data, version: user.version + 1 }
-     });`
-      }
-    ],
-    reasoning: 'Attempting to use optimistic locking on the user record update. However, the current schema does not support versioning, causing the patch to fail validation.',
+      },
+      {
+        path: 'src/hooks/useAuth.ts',
+        status: 'modified',
+        language: 'typescript',
+        diff: `@@ -8,4 +8,12 @@
+   const login = async (creds: Credentials) => {
+     const res = await api.post('/login', creds);
+     setUser(res.user);
+   };
+
+   const logout = () => {
+     setUser(null);
+     document.cookie = 'refresh_token=; Max-Age=0';
+   };`
+      },
+      {
+        path: 'src/services/tokenStore.ts',
+        status: 'created',
+        language: 'typescript',
+        diff: `@@ -0,0 +1,15 @@
+export class TokenStore {
+  private static cache = new Map<string, string>();
+  
+  static set(id: string, val: string) {
+    this.cache.set(id, val);
+  }
+  
+  static get(id: string) {
+    return this.cache.get(id);
+  }
+}`
+      },
+      {
+        path: 'src/types/auth.types.ts',
+        status: 'modified',
+        language: 'typescript',
+        diff: `@@ -2,4 +2,5 @@
+ export interface User {
+   id: string;
+   email: string;
+   role: 'admin' | 'user';
+   lastSeen: string;
+ }`
+      },
+      {
+        path: 'src/utils/crypto.ts',
+        status: 'modified',
+        language: 'typescript',
+        diff: `@@ -1,3 +1,6 @@
+ import crypto from 'crypto';
+ 
+ export const hashToken = (t: string) => 
+   crypto.createHash('sha256').update(t).digest('hex');`
+      }
+    ],
+    reasoning: `### Architectural Security Report: JWT Rotation
+We are implementing **Sliding Sessions** to improve both security and user experience. 
+
+#### Key Objectives:
+1. **Short-lived Access Tokens**: Access tokens now expire in 15 minutes.
+2. **Refresh Token Rotation**: Every time a session is refreshed, a *new* refresh token is issued, and the old one is invalidated (Detects reuse).
+3. **In-memory Token Store**: Added \`TokenStore\` to track active session IDs for instant revocation.
+
+> **Security Note:** This change requires the backend to support the \`/rotate\` endpoint which is defined in the accompanying server-side patch.`,
     provider: 'Anthropic',
-    model: 'claude-3.5-sonnet',
-    cost: '$0.045',
-    tokens: '2,100'
+    model: 'claude-3.5-sonnet',
+    cost: '$0.032',
+    tokens: '1,850'
   },
@@ ... @@
```

### Part 3/3: Layout & Scrolling Refinement

Finally, we ensure the Dashboard container and global styles support this long-form document flow without visual clutter.

```css // src/styles/main.style.css standard-diff
--- src/styles/main.style.css
+++ src/styles/main.style.css
@@ ... @@
-  .pb-safe {
-    padding-bottom: env(safe-area-inset-bottom);
-  }
+  .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
+  
+  /* Ensure smooth scrolling for sticky headers */
+  html { scroll-behavior: smooth; }
+  
+  /* High-contrast text for reports */
+  .prose p { margin-bottom: 1.5em; line-height: 1.75; }
+  .prose strong { color: var(--color-white); font-weight: 600; }
+  .prose blockquote { 
+    border-left-color: var(--color-indigo-500);
+    background: rgba(99, 102, 241, 0.05);
+    padding: 1rem;
+    border-radius: 0.5rem;
+    font-style: normal;
+  }
 }
```

```typescript // src/pages/dashboard.page.tsx standard-diff
--- src/pages/dashboard.page.tsx
+++ src/pages/dashboard.page.tsx
@@ ... @@
-        <div className="space-y-3 min-h-[300px] mt-8">
+        <div className="space-y-3 min-h-[300px] mt-12">
           <AnimatePresence mode='popLayout'>
             {hasTransactions ? (
               groupedData.map((group) => {
@@ ... @@
-                          <div className="space-y-3 pl-0 md:pl-2 border-l-0 md:border-l border-zinc-800/50 ml-3">
+                          <div className="space-y-6 pl-0 md:pl-2 border-l-0 md:border-l border-zinc-800/30 ml-3 py-4">
                             {group.transactions.map((tx) => (
```

```yaml
projectId: react-vite-tailwind
uuid: f2a9e8b1-7c5d-4e2a-9f1b-3d6e8a7c2b4f
changeSummary:
  - edit: src/features/transactions/components/transaction-card.component.tsx
  - edit: src/services/api.service.ts
  - edit: src/styles/main.style.css
  - edit: src/pages/dashboard.page.tsx
promptSummary: Overhauled TransactionCard for a document-style technical report. Implemented sticky headers, Markdown reasoning, and multi-file diff rendering (5+ files per change).
gitCommitMsg: >-
  feat(ui): implement document-style transaction reports

  - Added sticky headers for transaction controls.
  - Integrated react-markdown for architectural reasoning.
  - Refactored layout for multi-file technical breakdowns.
  - Updated mock data with realistic 5-file security patches.
```

To make the reports feel truly "comprehensive" and allow for reasoning text to be interleaved between code blocks (as seen in the `relay.md` example), we need to evolve the data structure from a simple "Reasoning + Files" model to a **Narrative Block** model.

### Part 2/3: The Narrative Engine & Multi-File Architecture

In this part, we will:
1.  **Refactor Types**: Introduce `TransactionBlock` to allow arbitrary interleaving of Markdown and Code.
2.  **Update Mock Data**: Create a massive "Real-time Notification System" patch with 8+ files and contextual reasoning between each major architectural change.
3.  **Update UI**: Modify the `TransactionCard` to render this narrative sequence.

```typescript // src/types/app.types.ts standard-diff
--- src/types/app.types.ts
+++ src/types/app.types.ts
@@ ... @@
-export interface Transaction {
-  id: string;
-  status: TransactionStatus;
-  description: string;
-  timestamp: string; // Display string (e.g., "Just now")
-  createdAt: string; // ISO Date string for grouping/sorting
-  promptId: string;  // Foreign key to Prompt
-  author: string;    // For grouping by commit author
-  files: TransactionFile[];
-  reasoning: string;
-  provider: string;
-  model: string;
-  cost: string;
-  tokens: string;
-}
+export type TransactionBlock = 
+  | { type: 'markdown'; content: string }
+  | { type: 'file'; file: TransactionFile };
+
+export interface Transaction {
+  id: string;
+  status: TransactionStatus;
+  description: string;
+  timestamp: string;
+  createdAt: string;
+  promptId: string;
+  author: string;
+  blocks: TransactionBlock[]; // New narrative structure
+  files: TransactionFile[];   // Keep for compatibility/summaries
+  provider: string;
+  model: string;
+  cost: string;
+  tokens: string;
+  reasoning: string; // Legacy fallback
+}
```

```typescript // src/services/api.service.ts standard-diff
--- src/services/api.service.ts
+++ src/services/api.service.ts
@@ ... @@
-  {
-    id: 'tx-complex-auth',
-    status: 'PENDING',
-    description: 'Security Overhaul: JWT Rotation & Session Management',
-    timestamp: 'Just now',
-    createdAt: new Date().toISOString(),
-    promptId: 'prompt-1',
-    author: 'alice',
-    files: [
-      {
-        path: 'src/middleware/auth.ts',
-        status: 'modified',
-        language: 'typescript',
-        diff: `@@ -12,6 +12,14 @@
- async function authMiddleware(req: Request, res: Response, next: NextFunction) {
-   const token = req.headers.authorization?.split(' ')[1];
-   
-   if (!token) {
--    return res.status(401).json({ message: 'No token provided' });
-+    // Check for refresh token in cookies
-+    const refreshToken = req.cookies['refresh_token'];
-+    if (!refreshToken) {
-+      return res.status(401).json({ message: 'Authentication required' });
-+    }
-+    
-+    // Rotate tokens
-+    const newTokens = await rotateTokens(refreshToken);
-   }
- }`
-      },
-      {
-        path: 'src/config/jwt.ts',
-        status: 'created',
-        language: 'typescript',
-        diff: `@@ -0,0 +1,8 @@
-+export const JWT_CONFIG = {
-+  secret: process.env.JWT_SECRET || 'dev-secret',
-+  expiresIn: '15m',
-+  refreshExpiresIn: '7d',
-+  issuer: 'relaycode-api',
-+  audience: 'relaycode-web'
-+};`
-      }
-    ],
-        reasoning: `### Security Upgrade: JWT Rotation
-    The user requested robust JWT rotation. I am updating the authentication flow to support **sliding sessions**.
-
-    **Key Changes:**
-    - Added \`rotateTokens\` logic to the auth middleware.
-    - If a valid access token is missing but a refresh token exists, we issue a new pair instantly.
-    - Updated the \`JWT_CONFIG\` to include strict audience and issuer validation.
-
-    > This ensures seamless user sessions without frequent re-logins while maintaining high security.`,
-    provider: 'Anthropic',
-    model: 'claude-3.5-sonnet',
-    cost: '$0.024',
-    tokens: '1,240'
-  },
+  {
+    id: 'tx-fullstack-notify',
+    status: 'PENDING',
+    description: 'Feature: Real-time Notification System with Socket.io',
+    timestamp: 'Just now',
+    createdAt: new Date().toISOString(),
+    promptId: 'prompt-2',
+    author: 'system',
+    provider: 'Claude',
+    model: '3.5 Sonnet',
+    cost: '$0.084',
+    tokens: '4,120',
+    reasoning: 'Implementing full-stack notifications.',
+    files: [], // Populated via blocks below for logic consistency
+    blocks: [
+      { type: 'markdown', content: `### Notification System Architecture
+I am implementing a robust real-time notification engine. This involves updating the database schema, creating a WebSocket gateway, and adding frontend hooks.
+
+#### 1. Database Schema
+First, we need to track notification state and read/unread status.` },
+      { type: 'file', file: {
+        path: 'prisma/schema.prisma',
+        status: 'modified',
+        language: 'prisma',
+        diff: `@@ -45,6 +45,14 @@
+ model User {
+   id    String @id @default(cuid())
+   email String @unique
++  notifications Notification[]
+ }
+ 
++model Notification {
++  id        String   @id @default(cuid())
++  userId    String
++  user      User     @relation(fields: [userId], references: [id])
++  type      String
++  message   String
++  read      Boolean  @default(false)
++  createdAt DateTime @default(now())
++}`
+      }},
+      { type: 'markdown', content: `#### 2. WebSocket Gateway
+Now, let's create the NestJS gateway to handle client connections and emit events.` },
+      { type: 'file', file: {
+        path: 'server/src/notifications/notifications.gateway.ts',
+        status: 'created',
+        language: 'typescript',
+        diff: `@@ -0,0 +1,15 @@
+@WebSocketGateway({ cors: true })
+export class NotificationsGateway {
+  @WebSocketServer() server: Server;
+
+  sendToUser(userId: string, data: any) {
+    this.server.to(userId).emit('notification', data);
+  }
+}`
+      }},
+      { type: 'markdown', content: `#### 3. Frontend Integration
+The following 5 files set up the React state management, hooks, and UI components for the notification bell.` },
+      { type: 'file', file: {
+        path: 'client/src/hooks/useNotifications.ts',
+        status: 'created',
+        language: 'typescript',
+        diff: `@@ -0,0 +1,10 @@
+export const useNotifications = () => {
+  const [notes, setNotes] = useState([]);
+  useEffect(() => {
+    socket.on('notification', (n) => setNotes(prev => [n, ...prev]));
+  }, []);
+  return notes;
+};`
+      }},
+      { type: 'file', file: {
+        path: 'client/src/store/notification.slice.ts',
+        status: 'created',
+        language: 'typescript',
+        diff: `@@ -0,0 +1,5 @@
+export const createNotificationSlice = (set) => ({
+  unreadCount: 0,
+  increment: () => set(s => ({ unreadCount: s.unreadCount + 1 })),
+});`
+      }},
+      { type: 'file', file: {
+        path: 'client/src/components/NotificationBell.tsx',
+        status: 'created',
+        language: 'tsx',
+        diff: `@@ -0,0 +1,8 @@
+export const NotificationBell = () => {
+  const count = useStore(s => s.unreadCount);
+  return <div className="relative"><Bell />{count > 0 && <span>{count}</span>}</div>;
+};`
+      }},
+      { type: 'file', file: {
+        path: 'client/src/styles/notifications.css',
+        status: 'created',
+        language: 'css',
+        diff: `@@ -0,0 +1,4 @@
+.notification-item {
+  @apply p-4 border-b border-zinc-800 hover:bg-zinc-900;
+}`
+      }},
+      { type: 'file', file: {
+        path: 'server/src/main.ts',
+        status: 'modified',
+        language: 'typescript',
+        diff: `@@ -5,4 +5,5 @@
+   const app = await NestFactory.create(AppModule);
+   app.enableCors();
++  app.useWebSocketAdapter(new IoAdapter(app));
+   await app.listen(3000);`
+      }},
+      { type: 'markdown', content: `### Final Considerations
+The Socket.io adapter must be installed on the server for this to work. I have updated the \`package.json\` below.` },
+      { type: 'file', file: {
+        path: 'server/package.json',
+        status: 'modified',
+        language: 'json',
+        diff: `@@ -12,4 +12,5 @@
+   "dependencies": {
+     "@nestjs/common": "^10.0.0",
+     "@nestjs/core": "^10.0.0",
++    "@nestjs/platform-socket.io": "^10.0.0"
+   }`
+      }}
+    ]
+  },
```

```typescript // src/features/transactions/components/transaction-card.component.tsx standard-diff
--- src/features/transactions/components/transaction-card.component.tsx
+++ src/features/transactions/components/transaction-card.component.tsx
@@ ... @@
-            <div className="p-6 md:p-10 space-y-16 max-w-5xl mx-auto">
-              {/* Reasoning Section */}
-              <section className="space-y-4">
-                <div className="flex items-center gap-2 text-zinc-500">
-                   <Zap className="w-4 h-4 text-amber-500" />
-                   <h4 className="text-[11px] uppercase font-bold tracking-[0.2em]">Architectural Intent</h4>
-                </div>
-                <div className="prose prose-zinc prose-invert prose-sm max-w-none bg-zinc-900/20 p-6 rounded-2xl border border-zinc-800/40">
-                  <ReactMarkdown remarkPlugins={[remarkGfm]}>
-                    {tx.reasoning}
-                  </ReactMarkdown>
-                </div>
-              </section>
-
-              {/* Implementation / File Stream */}
-              <section className="space-y-6">
-                 <div className="flex items-center gap-2 text-zinc-500">
-                   <FileCode className="w-4 h-4 text-indigo-500" />
-                   <h4 className="text-[11px] uppercase font-bold tracking-[0.2em]">Implementation ({tx.files.length} Changes)</h4>
-                </div>
-                
-                <div className="grid grid-cols-1 gap-12">
-                  {tx.files.map((file, i) => {
-                    const stats = getDiffStats(file.diff);
-                    return (
-                      <div key={i} className="space-y-3">
-                        {/* File Meta */}
-                        <div className="flex items-center justify-between px-2">
-                           <div className="flex items-center gap-3">
-                              <div className={cn(
-                                "w-1.5 h-1.5 rounded-full",
-                                file.status === 'modified' ? "bg-amber-500 shadow-[0_0_8px_rgba(245,158,11,0.5)]" : 
-                                file.status === 'created' ? "bg-emerald-500 shadow-[0_0_8px_rgba(16,185,129,0.5)]" : "bg-red-500"
-                              )} />
-                              <span className="text-xs font-mono text-zinc-300">{file.path}</span>
-                           </div>
-                           <div className="flex items-center gap-3 text-[10px] font-mono">
-                              <span className="text-emerald-500/80">+{stats.adds}</span>
-                              <span className="text-red-500/80">-{stats.subs}</span>
-                           </div>
-                        </div>
-
-                        {/* File Diff Window */}
-                        <div className="group/file border border-zinc-800/80 rounded-xl overflow-hidden bg-zinc-950 shadow-2xl transition-all hover:border-zinc-700/50">
-                           <div className="flex items-center justify-between px-4 py-2 bg-zinc-900/60 border-b border-zinc-800/80">
-                              <div className="flex gap-1.5">
-                                 <div className="w-2 h-2 rounded-full bg-zinc-800" />
-                                 <div className="w-2 h-2 rounded-full bg-zinc-800" />
-                                 <div className="w-2 h-2 rounded-full bg-zinc-800" />
-                              </div>
-                              <button className="p-1 text-zinc-600 hover:text-white transition-colors opacity-0 group-hover/file:opacity-100">
-                                 <Copy className="w-3.5 h-3.5" />
-                              </button>
-                           </div>
-                           <DiffViewer diff={file.diff} language={file.language} className="max-h-[500px]" />
-                        </div>
-                      </div>
-                    );
-                  })}
-                </div>
-              </section>
+            <div className="p-6 md:p-10 space-y-12 max-w-5xl mx-auto">
+              {/* NARRATIVE FLOW */}
+              {(tx.blocks || []).length > 0 ? (
+                tx.blocks.map((block, i) => (
+                  <div key={i}>
+                    {block.type === 'markdown' ? (
+                      <div className="prose prose-zinc prose-invert prose-sm max-w-none px-4 mb-8">
+                        <ReactMarkdown remarkPlugins={[remarkGfm]}>
+                          {block.content}
+                        </ReactMarkdown>
+                      </div>
+                    ) : (
+                      <FileSection file={block.file} />
+                    )}
+                  </div>
+                ))
+              ) : (
+                /* Legacy Rendering Fallback */
+                <>
+                  <div className="prose prose-zinc prose-invert prose-sm max-w-none px-4">
+                    <ReactMarkdown remarkPlugins={[remarkGfm]}>
+                      {tx.reasoning}
+                    </ReactMarkdown>
+                  </div>
+                  <div className="grid grid-cols-1 gap-12 pt-8">
+                    {tx.files.map((file, i) => (
+                      <FileSection key={i} file={file} />
+                    ))}
+                  </div>
+                </>
+              )}
@@ ... @@
+const FileSection = ({ file }: { file: any }) => {
+  const stats = getDiffStats(file.diff);
+  return (
+    <div className="space-y-3 mb-10">
+      <div className="flex items-center justify-between px-2">
+        <div className="flex items-center gap-3">
+          <div className={cn(
+            "w-1.5 h-1.5 rounded-full",
+            file.status === 'modified' ? "bg-amber-500 shadow-[0_0_8px_rgba(245,158,11,0.5)]" : 
+            file.status === 'created' ? "bg-emerald-500 shadow-[0_0_8px_rgba(16,185,129,0.5)]" : "bg-red-500"
+          )} />
+          <span className="text-xs font-mono text-zinc-300">{file.path}</span>
+        </div>
+        <div className="flex items-center gap-3 text-[10px] font-mono">
+          <span className="text-emerald-500/80">+{stats.adds}</span>
+          <span className="text-red-500/80">-{stats.subs}</span>
+        </div>
+      </div>
+      <div className="group/file border border-zinc-800/80 rounded-xl overflow-hidden bg-zinc-950 shadow-2xl transition-all hover:border-zinc-700/50">
+        <div className="flex items-center justify-between px-4 py-2 bg-zinc-900/60 border-b border-zinc-800/80">
+          <div className="flex gap-1.5">
+            <div className="w-2 h-2 rounded-full bg-zinc-800" />
+            <div className="w-2 h-2 rounded-full bg-zinc-800" />
+            <div className="w-2 h-2 rounded-full bg-zinc-800" />
+          </div>
+          <button className="p-1 text-zinc-600 hover:text-white transition-colors opacity-0 group-hover/file:opacity-100">
+            <Copy className="w-3.5 h-3.5" />
+          </button>
+        </div>
+        <DiffViewer diff={file.diff} language={file.language} className="max-h-[500px]" />
+      </div>
+    </div>
+  );
+};
```

### Part 3/3: Fixing Stickiness & CSS Depth

The user noted "no sticky part on scroll?". This usually happens because `motion.div` with certain layouts or `overflow-hidden` on parent containers breaks the CSS `sticky` context. We'll fix the scroll container hierarchy.

```css // src/styles/main.style.css standard-diff
--- src/styles/main.style.css
+++ src/styles/main.style.css
@@ ... @@
-  /* Ensure smooth scrolling for sticky headers */
-  html { scroll-behavior: smooth; }
+  /* Ensure smooth scrolling and proper sticky context */
+  html { 
+    scroll-behavior: smooth; 
+    height: 100%;
+  }
+  
+  body {
+    min-height: 100%;
+    overflow-x: hidden;
+    overflow-y: auto;
+  }
```

```typescript // src/root.tsx standard-diff
--- src/root.tsx
+++ src/root.tsx
@@ ... @@
-          <div className={cn("flex flex-col min-h-screen transition-all duration-300", isMobile ? "pb-20" : "pl-64")}>
+          <div className={cn("flex flex-col min-h-screen transition-all duration-300 isolate", isMobile ? "pb-20" : "pl-64")}>
```

```yaml
projectId: react-vite-tailwind
uuid: 1a2b3c4d-5e6f-7g8h-9i0j-1k2l3m4n5o6p
changeSummary:
  - edit: src/types/app.types.ts
  - edit: src/services/api.service.ts
  - edit: src/features/transactions/components/transaction-card.component.tsx
  - edit: src/styles/main.style.css
  - edit: src/root.tsx
promptSummary: Introduced Narrative Block architecture to support interleaved Markdown and Code. Added 8-file complex mock data and fixed CSS sticky header issues.
gitCommitMsg: >-
  feat(narrative): implement interleaved reasoning and code blocks

  - Redefined Transaction type to support narrative blocks.
  - Added realistic 8-file notification system patch with interleaved reasoning.
  - Fixed sticky header context by refining root scroll behavior.
  - Updated TransactionCard to render narrative sequences.
```

This final part focuses on **Developer Productivity** and **Information Density**. When dealing with reports that contain 8+ files, navigation becomes the bottleneck. 

In this part, we will:
1.  **Implement a File Navigator**: A "Table of Contents" sidebar that appears when a transaction is expanded, allowing instant jumping to specific file diffs.
2.  **Refine the Command Palette**: Enable deep-search within the narrative blocks (searching code and reasoning text).
3.  **Add "Copy All" and "Raw View" primitives**: Enhancing the "Living Document" feel with utility actions.

### Part 3/3: Technical Navigation & Deep Search

```typescript // src/features/transactions/components/transaction-card.component.tsx standard-diff
--- src/features/transactions/components/transaction-card.component.tsx
+++ src/features/transactions/components/transaction-card.component.tsx
@@ ... @@
-import { 
-  CheckCircle2, 
-  MoreHorizontal, 
-  ChevronDown, 
-  FileCode, 
-  Zap, 
-  Copy, 
-  Terminal,
-  Cpu,
-  Coins,
-  History,
-  ExternalLink
-} from 'lucide-react';
+import { 
+  CheckCircle2, 
+  MoreHorizontal, 
+  ChevronDown, 
+  FileCode, 
+  Zap, 
+  Copy, 
+  Terminal,
+  Cpu,
+  Coins,
+  History,
+  ExternalLink,
+  ListTree
+} from 'lucide-react';
@@ ... @@
+  const scrollToId = (id: string) => {
+    const el = document.getElementById(id);
+    if (el) {
+      const offset = 80; // Account for sticky header
+      const bodyRect = document.body.getBoundingClientRect().top;
+      const elementRect = el.getBoundingClientRect().top;
+      const elementPosition = elementRect - bodyRect;
+      const offsetPosition = elementPosition - offset;
+
+      window.scrollTo({
+        top: offsetPosition,
+        behavior: 'smooth'
+      });
+    }
+  };
+
   return (
@@ ... @@
-            <div className="p-6 md:p-10 space-y-12 max-w-5xl mx-auto">
+            <div className="flex flex-col lg:flex-row gap-0 lg:gap-10 p-4 md:p-10 max-w-[1400px] mx-auto relative">
+              
+              {/* QUICK JUMP SIDEBAR (Desktop) */}
+              <div className="hidden lg:block w-64 shrink-0">
+                <div className="sticky top-24 space-y-6">
+                  <div className="flex items-center gap-2 text-zinc-500 mb-4">
+                    <ListTree className="w-4 h-4" />
+                    <span className="text-[10px] uppercase font-bold tracking-widest">Outline</span>
+                  </div>
+                  <nav className="space-y-1 max-h-[calc(100vh-200px)] overflow-y-auto custom-scrollbar-thin pr-2">
+                    {tx.blocks?.filter(b => b.type === 'file').map((block, idx) => (
+                      <button 
+                        key={idx}
+                        onClick={() => scrollToId(`${tx.id}-file-${idx}`)}
+                        className="w-full text-left px-3 py-2 rounded-lg text-[11px] font-mono text-zinc-500 hover:text-indigo-400 hover:bg-indigo-500/5 transition-all truncate group"
+                      >
+                        <span className="opacity-0 group-hover:opacity-100 mr-1 text-indigo-500">#</span>
+                        {(block as any).file.path.split('/').pop()}
+                      </button>
+                    ))}
+                  </nav>
+                </div>
+              </div>
+
+              {/* MAIN CONTENT STREAM */}
+              <div className="flex-1 space-y-12 min-w-0">
-              {/* NARRATIVE FLOW */}
-              {(tx.blocks || []).length > 0 ? (
-                tx.blocks.map((block, i) => (
-                  <div key={i}>
-                    {block.type === 'markdown' ? (
-                      <div className="prose prose-zinc prose-invert prose-sm max-w-none px-4 mb-8">
-                        <ReactMarkdown remarkPlugins={[remarkGfm]}>
-                          {block.content}
-                        </ReactMarkdown>
-                      </div>
-                    ) : (
-                      <FileSection file={block.file} />
-                    )}
-                  </div>
-                ))
-              ) : (
-                /* Legacy Rendering Fallback */
-                <>
-                  <div className="prose prose-zinc prose-invert prose-sm max-w-none px-4">
-                    <ReactMarkdown remarkPlugins={[remarkGfm]}>
-                      {tx.reasoning}
-                    </ReactMarkdown>
-                  </div>
-                  <div className="grid grid-cols-1 gap-12 pt-8">
-                    {tx.files.map((file, i) => (
-                      <FileSection key={i} file={file} />
-                    ))}
-                  </div>
-                </>
-              )}
+                {(tx.blocks || []).length > 0 ? (
+                  tx.blocks.map((block, i) => (
+                    <div key={i} id={block.type === 'file' ? `${tx.id}-file-${i}` : undefined}>
+                      {block.type === 'markdown' ? (
+                        <div className="prose prose-zinc prose-invert prose-sm max-w-none px-4 mb-8">
+                          <ReactMarkdown remarkPlugins={[remarkGfm]}>
+                            {block.content}
+                          </ReactMarkdown>
+                        </div>
+                      ) : (
+                        <FileSection file={block.file} />
+                      )}
+                    </div>
+                  ))
+                ) : (
+                  /* Fallback omitted for brevity */
+                  null
+                )}
+              </div>
+            </div>
```

### Part 3b: Deep Narrative Search

We update the `CommandPalette` to scan through the rich `blocks` data structure, making the tool much more powerful for auditing large changes.

```typescript // src/components/layout/command-palette.layout.tsx standard-diff
--- src/components/layout/command-palette.layout.tsx
+++ src/components/layout/command-palette.layout.tsx
@@ ... @@
-import { Search, Play, CheckCircle2, RefreshCw } from 'lucide-react';
+import { Search, Play, CheckCircle2, RefreshCw, FileText, Code2 } from 'lucide-react';
 import { motion } from 'framer-motion';
 import { useStore } from "@/store/root.store";
+import { useState, useMemo } from 'react';
 
 export const CommandPalette = () => {
   const isCmdOpen = useStore((state) => state.isCmdOpen);
   const setCmdOpen = useStore((state) => state.setCmdOpen);
+  const transactions = useStore((state) => state.transactions);
+  const [query, setQuery] = useState("");
+
+  const results = useMemo(() => {
+    if (!query || query.length < 2) return [];
+    const matches: any[] = [];
+    
+    transactions.forEach(tx => {
+      // Search in description
+      if (tx.description.toLowerCase().includes(query.toLowerCase())) {
+        matches.push({ type: 'tx', id: tx.id, title: tx.description, subtitle: 'Transaction' });
+      }
+      
+      // Search in blocks
+      tx.blocks?.forEach(block => {
+        if (block.type === 'markdown' && block.content.toLowerCase().includes(query.toLowerCase())) {
+          matches.push({ type: 'doc', id: tx.id, title: 'Reasoning match...', subtitle: tx.description });
+        }
+        if (block.type === 'file' && block.file.path.toLowerCase().includes(query.toLowerCase())) {
+          matches.push({ type: 'file', id: tx.id, title: block.file.path, subtitle: tx.description });
+        }
+      });
+    });
+    return matches.slice(0, 5);
+  }, [query, transactions]);
   
   if (!isCmdOpen) return null;
@@ ... @@
-          <input 
+          <input
+            value={query}
+            onChange={(e) => setQuery(e.target.value)}
             autoFocus
@@ ... @@
-        <div className="p-2 space-y-1">
+        <div className="p-2 space-y-1 max-h-96 overflow-y-auto custom-scrollbar-thin">
+          {results.length > 0 ? (
+            <>
+              <div className="px-2 py-1.5 text-xs font-semibold text-zinc-500 uppercase tracking-wider">Search Results</div>
+              {results.map((res, i) => (
+                <button key={i} className="w-full flex items-center gap-3 px-3 py-2 text-sm text-zinc-300 hover:bg-zinc-800 hover:text-white rounded-lg transition-colors group">
+                  {res.type === 'file' ? <Code2 className="w-4 h-4 text-zinc-500" /> : <FileText className="w-4 h-4 text-zinc-500" />}
+                  <div className="flex flex-col items-start overflow-hidden">
+                    <span className="truncate w-full">{res.title}</span>
+                    <span className="text-[10px] text-zinc-600 truncate w-full">{res.subtitle}</span>
+                  </div>
+                </button>
+              ))}
+            </>
+          ) : query ? (
+             <div className="p-8 text-center text-zinc-500 text-sm">No matches found for "{query}"</div>
+          ) : (
+            <>
-          <div className="px-2 py-1.5 text-xs font-semibold text-zinc-500 uppercase tracking-wider">Actions</div>
-          <button className="w-full flex items-center gap-3 px-3 py-2 text-sm text-zinc-300 hover:bg-zinc-800 hover:text-white rounded-lg transition-colors group">
-            <Play className="w-4 h-4 text-zinc-500 group-hover:text-emerald-500" />
-            Resume Monitoring
-          </button>
-          <button className="w-full flex items-center gap-3 px-3 py-2 text-sm text-zinc-300 hover:bg-zinc-800 hover:text-white rounded-lg transition-colors group">
-            <CheckCircle2 className="w-4 h-4 text-zinc-500 group-hover:text-emerald-500" />
-            Approve All Pending
-          </button>
-          <button className="w-full flex items-center gap-3 px-3 py-2 text-sm text-zinc-300 hover:bg-zinc-800 hover:text-white rounded-lg transition-colors group">
-             <RefreshCw className="w-4 h-4 text-zinc-500 group-hover:text-blue-500" />
-             Retry Failed Patches
-          </button>
+              <div className="px-2 py-1.5 text-xs font-semibold text-zinc-500 uppercase tracking-wider">Quick Actions</div>
+              <button className="w-full flex items-center gap-3 px-3 py-2 text-sm text-zinc-300 hover:bg-zinc-800 hover:text-white rounded-lg transition-colors group">
+                <Play className="w-4 h-4 text-zinc-500 group-hover:text-emerald-500" />
+                Resume Monitoring
+              </button>
+              <button className="w-full flex items-center gap-3 px-3 py-2 text-sm text-zinc-300 hover:bg-zinc-800 hover:text-white rounded-lg transition-colors group">
+                <CheckCircle2 className="w-4 h-4 text-zinc-500 group-hover:text-emerald-500" />
+                Approve All Pending
+              </button>
+            </>
+          )}
         </div>
```

### Part 3c: Final CSS Consistency

Ensure the `custom-scrollbar-thin` is available for all scroll areas.

```css // src/styles/main.style.css standard-diff
--- src/styles/main.style.css
+++ src/styles/main.style.css
@@ ... @@
-/* Custom Scrollbar Thin */
-.custom-scrollbar-thin::-webkit-scrollbar {
-  width: 4px;
-  height: 4px;
-}
-
-.custom-scrollbar-thin::-webkit-scrollbar-thumb {
-  background: #3f3f46;
-  border-radius: 10px;
-}
+@layer utilities {
+  .custom-scrollbar-thin::-webkit-scrollbar {
+    width: 4px;
+    height: 4px;
+  }
+  .custom-scrollbar-thin::-webkit-scrollbar-thumb {
+    background: #27272a;
+    border-radius: 10px;
+  }
+  .custom-scrollbar-thin::-webkit-scrollbar-thumb:hover {
+    background: #3f3f46;
+  }
+}
```

```yaml
projectId: react-vite-tailwind
uuid: 4f5e6d7c-8b9a-0c1d-2e3f-4a5b6c7d8e9f
changeSummary:
  - edit: src/features/transactions/components/transaction-card.component.tsx
  - edit: src/components/layout/command-palette.layout.tsx
  - edit: src/styles/main.style.css
promptSummary: Added file navigation sidebar (Quick Jump) for expanded reports and implemented deep search within the Command Palette to scan through narrative blocks.
gitCommitMsg: >-
  feat(productivity): add navigation sidebar and deep search

  - Implemented 'Quick Jump' file navigator for multi-file reports.
  - Added smooth scroll logic to anchored file sections.
  - Enhanced Command Palette to index reasoning blocks and code paths.
  - Refined utility CSS for better scrollbar consistency.
```